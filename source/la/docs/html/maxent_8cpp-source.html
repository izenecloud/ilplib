<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>la-manager: /disk/workspace-cpp/la-manager/source/pos/maxent.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>/disk/workspace-cpp/la-manager/source/pos/maxent.cpp</h1><a href="maxent_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * $Id: maxent.cpp,v 1.15 2005/04/27 11:22:27 tsuruoka Exp $</span>
<a name="l00003"></a>00003 <span class="comment"> */</span>
<a name="l00004"></a>00004 
<a name="l00005"></a>00005 <span class="preprocessor">#include &lt;<a class="code" href="maxent_8h.html">pos/maxent.h</a>&gt;</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include &lt;cmath&gt;</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include &lt;cstdio&gt;</span>
<a name="l00008"></a>00008 
<a name="l00009"></a>00009 <span class="keyword">using namespace </span>std;
<a name="l00010"></a>00010 <span class="comment">/*</span>
<a name="l00011"></a>00011 <span class="comment">int</span>
<a name="l00012"></a>00012 <span class="comment">ME_Model::BLMVMFunctionGradient(double *x, double *f, double *g, int n)</span>
<a name="l00013"></a>00013 <span class="comment">{</span>
<a name="l00014"></a>00014 <span class="comment">  const int nf = _fb.Size();</span>
<a name="l00015"></a>00015 <span class="comment"></span>
<a name="l00016"></a>00016 <span class="comment">  if (_inequality_width &gt; 0) {</span>
<a name="l00017"></a>00017 <span class="comment">    assert(nf == n/2);</span>
<a name="l00018"></a>00018 <span class="comment">    for (int i = 0; i &lt; nf; i++) {</span>
<a name="l00019"></a>00019 <span class="comment">      _va[i] = x[i];</span>
<a name="l00020"></a>00020 <span class="comment">      _vb[i] = x[i + nf];</span>
<a name="l00021"></a>00021 <span class="comment">      _vl[i] = _va[i] - _vb[i];</span>
<a name="l00022"></a>00022 <span class="comment">    }</span>
<a name="l00023"></a>00023 <span class="comment">  } else {</span>
<a name="l00024"></a>00024 <span class="comment">    assert(nf == n);</span>
<a name="l00025"></a>00025 <span class="comment">    for (int i = 0; i &lt; n; i++) {</span>
<a name="l00026"></a>00026 <span class="comment">      _vl[i] = x[i];</span>
<a name="l00027"></a>00027 <span class="comment">    }</span>
<a name="l00028"></a>00028 <span class="comment">  }</span>
<a name="l00029"></a>00029 <span class="comment"></span>
<a name="l00030"></a>00030 <span class="comment">  double score = update_model_expectation();</span>
<a name="l00031"></a>00031 <span class="comment"></span>
<a name="l00032"></a>00032 <span class="comment">  if (_inequality_width &gt; 0) {</span>
<a name="l00033"></a>00033 <span class="comment">    for (int i = 0; i &lt; nf; i++) {</span>
<a name="l00034"></a>00034 <span class="comment">      g[i]      = -(_vee[i] - _vme[i] - _inequality_width);</span>
<a name="l00035"></a>00035 <span class="comment">      g[i + nf] = -(_vme[i] - _vee[i] - _inequality_width);</span>
<a name="l00036"></a>00036 <span class="comment">    }</span>
<a name="l00037"></a>00037 <span class="comment">  } else {</span>
<a name="l00038"></a>00038 <span class="comment">    if (_sigma == 0) {</span>
<a name="l00039"></a>00039 <span class="comment">      for (int i = 0; i &lt; n; i++) {</span>
<a name="l00040"></a>00040 <span class="comment">        g[i] = -(_vee[i] - _vme[i]);</span>
<a name="l00041"></a>00041 <span class="comment">      }</span>
<a name="l00042"></a>00042 <span class="comment">    } else {</span>
<a name="l00043"></a>00043 <span class="comment">      const double c = 1 / (_sigma * _sigma);</span>
<a name="l00044"></a>00044 <span class="comment">      for (int i = 0; i &lt; n; i++) {</span>
<a name="l00045"></a>00045 <span class="comment">        g[i] = -(_vee[i] - _vme[i] - c * _vl[i]);</span>
<a name="l00046"></a>00046 <span class="comment">      }</span>
<a name="l00047"></a>00047 <span class="comment">    }</span>
<a name="l00048"></a>00048 <span class="comment">  }</span>
<a name="l00049"></a>00049 <span class="comment"></span>
<a name="l00050"></a>00050 <span class="comment">  *f = -score;</span>
<a name="l00051"></a>00051 <span class="comment"></span>
<a name="l00052"></a>00052 <span class="comment">  return 0;</span>
<a name="l00053"></a>00053 <span class="comment">}</span>
<a name="l00054"></a>00054 <span class="comment"></span>
<a name="l00055"></a>00055 <span class="comment">int</span>
<a name="l00056"></a>00056 <span class="comment">ME_Model::BLMVMLowerAndUpperBounds(double *xl,double *xu,int n)</span>
<a name="l00057"></a>00057 <span class="comment">{</span>
<a name="l00058"></a>00058 <span class="comment">  if (_inequality_width &gt; 0) {</span>
<a name="l00059"></a>00059 <span class="comment">    for (int i = 0; i &lt; n; i++){</span>
<a name="l00060"></a>00060 <span class="comment">      xl[i] = 0;</span>
<a name="l00061"></a>00061 <span class="comment">      xu[i] = 10000.0;</span>
<a name="l00062"></a>00062 <span class="comment">    }</span>
<a name="l00063"></a>00063 <span class="comment">    return 0;</span>
<a name="l00064"></a>00064 <span class="comment">  }</span>
<a name="l00065"></a>00065 <span class="comment"></span>
<a name="l00066"></a>00066 <span class="comment">  for (int i = 0; i &lt; n; i++){</span>
<a name="l00067"></a>00067 <span class="comment">    xl[i] = -10000.0;</span>
<a name="l00068"></a>00068 <span class="comment">    xu[i] = 10000.0;</span>
<a name="l00069"></a>00069 <span class="comment">  }</span>
<a name="l00070"></a>00070 <span class="comment">  return 0;</span>
<a name="l00071"></a>00071 <span class="comment">}</span>
<a name="l00072"></a>00072 <span class="comment">*/</span>
<a name="l00073"></a>00073 <span class="keywordtype">int</span>
<a name="l00074"></a><a class="code" href="classME__Model.html#4ae94151fff132f87341a1c5f91b38d1">00074</a> <a class="code" href="classME__Model.html#4ae94151fff132f87341a1c5f91b38d1">ME_Model::perform_GIS</a>(<span class="keywordtype">int</span> C)
<a name="l00075"></a>00075 {
<a name="l00076"></a>00076   cerr &lt;&lt; <span class="stringliteral">"C = "</span> &lt;&lt; C &lt;&lt; endl;
<a name="l00077"></a>00077   C = 1;
<a name="l00078"></a>00078   cerr &lt;&lt; <span class="stringliteral">"performing AGIS"</span> &lt;&lt; endl;
<a name="l00079"></a>00079   <a class="code" href="classstd_1_1vector.html">vector&lt;double&gt;</a> pre_v;
<a name="l00080"></a>00080   <span class="keywordtype">double</span> pre_logl = -999999;
<a name="l00081"></a>00081   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iter = 0; iter &lt; 200; iter++) {
<a name="l00082"></a>00082 
<a name="l00083"></a>00083     <span class="keywordtype">double</span> logl =  <a class="code" href="classME__Model.html#d21f4e1132f6d710d41d4b3ef206d1f2">update_model_expectation</a>();
<a name="l00084"></a>00084     fprintf(stderr, <span class="stringliteral">"iter = %2d  C = %d  f = %10.7f  train_err = %7.5f"</span>, iter, C, logl, <a class="code" href="classME__Model.html#aab235eaccf24824812370d60ca079e4">_train_error</a>);
<a name="l00085"></a>00085     <span class="keywordflow">if</span> (<a class="code" href="classME__Model.html#ee10259b3dbbc99acb9c0f0e200b598b">_heldout</a>.size() &gt; 0) {
<a name="l00086"></a>00086       <span class="keywordtype">double</span> hlogl = <a class="code" href="classME__Model.html#39490060a9aa91c5bfef26db89995d81">heldout_likelihood</a>();
<a name="l00087"></a>00087       fprintf(stderr, <span class="stringliteral">"  heldout_logl(err) = %f (%6.4f)"</span>, hlogl, <a class="code" href="classME__Model.html#daf5973e7d0bf53c3d747da90dc20036">_heldout_error</a>);
<a name="l00088"></a>00088     }
<a name="l00089"></a>00089     cerr &lt;&lt; endl;
<a name="l00090"></a>00090 
<a name="l00091"></a>00091     <span class="keywordflow">if</span> (logl &lt; pre_logl) {
<a name="l00092"></a>00092       C += 1;
<a name="l00093"></a>00093       <a class="code" href="classME__Model.html#a0dc1dcca7431b816b27c1d7c9f0379a">_vl</a> = pre_v;
<a name="l00094"></a>00094       iter--;
<a name="l00095"></a>00095       <span class="keywordflow">continue</span>;
<a name="l00096"></a>00096     }
<a name="l00097"></a>00097     <span class="keywordflow">if</span> (C &gt; 1 &amp;&amp; iter % 10 == 0) C--;
<a name="l00098"></a>00098 
<a name="l00099"></a>00099     pre_logl = logl;
<a name="l00100"></a>00100     pre_v = <a class="code" href="classME__Model.html#a0dc1dcca7431b816b27c1d7c9f0379a">_vl</a>;
<a name="l00101"></a>00101     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#ef349bd03d50de36081b42ee5c717b86">Size</a>(); i++) {
<a name="l00102"></a>00102       <span class="keywordtype">double</span> coef = <a class="code" href="classME__Model.html#6d1c21872d8899cd512ce560216bcfda">_vee</a>[i] / <a class="code" href="classME__Model.html#f73cc90b01028ab54527df94d6c8a123">_vme</a>[i];
<a name="l00103"></a>00103       <a class="code" href="classME__Model.html#a0dc1dcca7431b816b27c1d7c9f0379a">_vl</a>[i] += log(coef) / C;
<a name="l00104"></a>00104     }
<a name="l00105"></a>00105   }
<a name="l00106"></a>00106   cerr &lt;&lt; endl;
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 }
<a name="l00109"></a>00109 
<a name="l00110"></a>00110 <span class="keywordtype">int</span>
<a name="l00111"></a><a class="code" href="classME__Model.html#754103cb516b470c0d74538e3fca78b6">00111</a> <a class="code" href="classME__Model.html#754103cb516b470c0d74538e3fca78b6">ME_Model::perform_LMVM</a>()
<a name="l00112"></a>00112 {
<a name="l00113"></a>00113   cerr &lt;&lt; <span class="stringliteral">"performing LMVM"</span> &lt;&lt; endl;
<a name="l00114"></a>00114 
<a name="l00115"></a>00115   <span class="keywordflow">if</span> (<a class="code" href="classME__Model.html#8fe5e308a2901c6792abe6c305491bcd">_inequality_width</a> &gt; 0) {
<a name="l00116"></a>00116     <span class="keywordtype">int</span> nvars = <a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#ef349bd03d50de36081b42ee5c717b86">Size</a>() * 2;
<a name="l00117"></a>00117     <span class="keywordtype">double</span> *x = (<span class="keywordtype">double</span>*)malloc(nvars*<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00118"></a>00118 
<a name="l00119"></a>00119     <span class="comment">// INITIAL POINT</span>
<a name="l00120"></a>00120     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nvars / 2; i++) {
<a name="l00121"></a>00121       x[i] = <a class="code" href="classME__Model.html#30e8d601c952bf0aa22da5837149e7a1">_va</a>[i];
<a name="l00122"></a>00122       x[i + <a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#ef349bd03d50de36081b42ee5c717b86">Size</a>()] = <a class="code" href="classME__Model.html#85968df26e2c2515e94e9d7dc5904d80">_vb</a>[i];
<a name="l00123"></a>00123     }
<a name="l00124"></a>00124 
<a name="l00125"></a>00125     <span class="comment">//    int info = BLMVMSolve(x, nvars);</span>
<a name="l00126"></a>00126 
<a name="l00127"></a>00127     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nvars / 2; i++) {
<a name="l00128"></a>00128       <a class="code" href="classME__Model.html#30e8d601c952bf0aa22da5837149e7a1">_va</a>[i] = x[i];
<a name="l00129"></a>00129       <a class="code" href="classME__Model.html#85968df26e2c2515e94e9d7dc5904d80">_vb</a>[i] = x[i + <a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#ef349bd03d50de36081b42ee5c717b86">Size</a>()];
<a name="l00130"></a>00130       <a class="code" href="classME__Model.html#a0dc1dcca7431b816b27c1d7c9f0379a">_vl</a>[i] = <a class="code" href="classME__Model.html#30e8d601c952bf0aa22da5837149e7a1">_va</a>[i] - <a class="code" href="classME__Model.html#85968df26e2c2515e94e9d7dc5904d80">_vb</a>[i];
<a name="l00131"></a>00131     }
<a name="l00132"></a>00132 
<a name="l00133"></a>00133     free(x);
<a name="l00134"></a>00134 
<a name="l00135"></a>00135     <span class="keywordflow">return</span> 0;
<a name="l00136"></a>00136   }
<a name="l00137"></a>00137 
<a name="l00138"></a>00138   <span class="keywordtype">int</span> nvars = <a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#ef349bd03d50de36081b42ee5c717b86">Size</a>();
<a name="l00139"></a>00139   <span class="keywordtype">double</span> *x = (<span class="keywordtype">double</span>*)malloc(nvars*<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00140"></a>00140 
<a name="l00141"></a>00141   <span class="comment">// INITIAL POINT</span>
<a name="l00142"></a>00142   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nvars; i++) { x[i] = <a class="code" href="classME__Model.html#a0dc1dcca7431b816b27c1d7c9f0379a">_vl</a>[i]; }
<a name="l00143"></a>00143 
<a name="l00144"></a>00144   <span class="comment">//  int info = BLMVMSolve(x, nvars);</span>
<a name="l00145"></a>00145 
<a name="l00146"></a>00146   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nvars; i++) { <a class="code" href="classME__Model.html#a0dc1dcca7431b816b27c1d7c9f0379a">_vl</a>[i] = x[i]; }
<a name="l00147"></a>00147 
<a name="l00148"></a>00148   free(x);
<a name="l00149"></a>00149 
<a name="l00150"></a>00150   <span class="keywordflow">return</span> 0;
<a name="l00151"></a>00151 }
<a name="l00152"></a>00152 
<a name="l00153"></a>00153 <span class="keywordtype">void</span>
<a name="l00154"></a><a class="code" href="classME__Model.html#8210bdb521edd5c9293b3ebba75d7c06">00154</a> <a class="code" href="classME__Model.html#8210bdb521edd5c9293b3ebba75d7c06">ME_Model::conditional_probability</a>(<span class="keyword">const</span> <a class="code" href="structME__Model_1_1Sample.html">Sample</a> &amp; nbs,
<a name="l00155"></a>00155                                   std::vector&lt;double&gt; &amp; membp)<span class="keyword"> const</span>
<a name="l00156"></a>00156 <span class="keyword"></span>{
<a name="l00157"></a>00157   <span class="keywordtype">int</span> <a class="code" href="classME__Model.html#eb9794bcc52f8a3a811ac81965ba49ce">num_classes</a> = membp.size();
<a name="l00158"></a>00158   <span class="keywordtype">double</span> sum = 0;
<a name="l00159"></a>00159   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> label = 0; label &lt; num_classes; label++) {
<a name="l00160"></a>00160     <span class="keywordtype">double</span> pow = 0.0;
<a name="l00161"></a>00161     <span class="keywordflow">for</span> (std::list&lt;int&gt;::const_iterator i = nbs.<a class="code" href="structME__Model_1_1Sample.html#5928a57beaa5ec61aa4bccb839e35773">positive_features</a>.begin(); i != nbs.<a class="code" href="structME__Model_1_1Sample.html#5928a57beaa5ec61aa4bccb839e35773">positive_features</a>.end(); i++){
<a name="l00162"></a>00162       <a class="code" href="structME__Model_1_1ME__Feature.html">ME_Feature</a> f(label, *i);
<a name="l00163"></a>00163       <span class="keywordtype">int</span> <span class="keywordtype">id</span> = <a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#91a032b84cb004c2aa9819bd5c727e29">Id</a>(f);
<a name="l00164"></a>00164       <span class="keywordflow">if</span> (<span class="keywordtype">id</span> &gt;= 0) {
<a name="l00165"></a>00165         pow += <a class="code" href="classME__Model.html#a0dc1dcca7431b816b27c1d7c9f0379a">_vl</a>[id];
<a name="l00166"></a>00166       }
<a name="l00167"></a>00167     }
<a name="l00168"></a>00168     <span class="keywordtype">double</span> prod = exp(pow);
<a name="l00169"></a>00169     membp[label] = prod;
<a name="l00170"></a>00170     sum += prod;
<a name="l00171"></a>00171   }
<a name="l00172"></a>00172   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> label = 0; label &lt; num_classes; label++) {
<a name="l00173"></a>00173     membp[label] /= sum;
<a name="l00174"></a>00174   }
<a name="l00175"></a>00175 
<a name="l00176"></a>00176 }
<a name="l00177"></a>00177 
<a name="l00178"></a>00178 <span class="keywordtype">int</span>
<a name="l00179"></a><a class="code" href="classME__Model.html#44b71ee757d6494e852ea36bacfe6634">00179</a> <a class="code" href="classME__Model.html#44b71ee757d6494e852ea36bacfe6634">ME_Model::make_feature_bag</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> cutoff)
<a name="l00180"></a>00180 {
<a name="l00181"></a>00181   <span class="keywordtype">int</span> max_label = 0;
<a name="l00182"></a>00182   <span class="keywordtype">int</span> max_num_features = 0;
<a name="l00183"></a>00183   <span class="keywordflow">for</span> (std::vector&lt;Sample&gt;::const_iterator i = <a class="code" href="classME__Model.html#01bbc4b24d88cda6c77db3ef17f48f19">_train</a>.begin(); i != <a class="code" href="classME__Model.html#01bbc4b24d88cda6c77db3ef17f48f19">_train</a>.end(); i++) {
<a name="l00184"></a>00184     max_label = max(max_label, i-&gt;label);
<a name="l00185"></a>00185   }
<a name="l00186"></a>00186   <a class="code" href="classME__Model.html#7a85f402ac9fea030c49f7c6216df686">_num_classes</a> = max_label + 1;
<a name="l00187"></a>00187 
<a name="l00188"></a>00188   <span class="comment">//  map&lt; int, list&lt;int&gt; &gt; feature2sample;</span>
<a name="l00189"></a>00189 
<a name="l00190"></a>00190   <span class="comment">// count the occurrences of features</span>
<a name="l00191"></a>00191 <span class="preprocessor">#ifdef USE_HASH_MAP</span>
<a name="l00192"></a>00192 <span class="preprocessor"></span>  <span class="keyword">typedef</span> __gnu_cxx::hash_map&lt;unsigned int, int&gt; map_type;
<a name="l00193"></a>00193 <span class="preprocessor">#else</span>
<a name="l00194"></a>00194 <span class="preprocessor"></span>  <span class="keyword">typedef</span> std::map&lt;unsigned int, int&gt; map_type;
<a name="l00195"></a>00195 <span class="preprocessor">#endif</span>
<a name="l00196"></a>00196 <span class="preprocessor"></span>  map_type count;
<a name="l00197"></a>00197   <span class="keywordflow">if</span> (cutoff &gt; 0) {
<a name="l00198"></a>00198     <span class="keywordflow">for</span> (std::vector&lt;Sample&gt;::const_iterator i = <a class="code" href="classME__Model.html#01bbc4b24d88cda6c77db3ef17f48f19">_train</a>.begin(); i != <a class="code" href="classME__Model.html#01bbc4b24d88cda6c77db3ef17f48f19">_train</a>.end(); i++) {
<a name="l00199"></a>00199       <span class="keywordflow">for</span> (std::list&lt;int&gt;::const_iterator j = i-&gt;positive_features.begin(); j != i-&gt;positive_features.end(); j++) {
<a name="l00200"></a>00200         count[<a class="code" href="structME__Model_1_1ME__Feature.html">ME_Feature</a>(i-&gt;label, *j).body()]++;
<a name="l00201"></a>00201       }
<a name="l00202"></a>00202     }
<a name="l00203"></a>00203   }
<a name="l00204"></a>00204 
<a name="l00205"></a>00205   <span class="keywordtype">int</span> n = 0;
<a name="l00206"></a>00206   <span class="keywordflow">for</span> (std::vector&lt;Sample&gt;::const_iterator i = <a class="code" href="classME__Model.html#01bbc4b24d88cda6c77db3ef17f48f19">_train</a>.begin(); i != <a class="code" href="classME__Model.html#01bbc4b24d88cda6c77db3ef17f48f19">_train</a>.end(); i++, n++) {
<a name="l00207"></a>00207     max_num_features = max(max_num_features, (<span class="keywordtype">int</span>)(i-&gt;positive_features.size()));
<a name="l00208"></a>00208     <span class="keywordflow">for</span> (std::list&lt;int&gt;::const_iterator j = i-&gt;positive_features.begin(); j != i-&gt;positive_features.end(); j++) {
<a name="l00209"></a>00209       <span class="keyword">const</span> <a class="code" href="structME__Model_1_1ME__Feature.html">ME_Feature</a> feature(i-&gt;label, *j);
<a name="l00210"></a>00210       <span class="keywordflow">if</span> (cutoff &gt; 0 &amp;&amp; count[feature.<a class="code" href="structME__Model_1_1ME__Feature.html#99e28a449267c9ccaacaa903c4147ec0">body</a>()] &lt; cutoff) <span class="keywordflow">continue</span>;
<a name="l00211"></a>00211       <span class="keywordtype">int</span> <span class="keywordtype">id</span> = <a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#48df0cadbce52d82f012afd809d0eed4">Put</a>(feature);
<a name="l00212"></a>00212       <span class="comment">//      cout &lt;&lt; i-&gt;label &lt;&lt; "\t" &lt;&lt; *j &lt;&lt; "\t" &lt;&lt; id &lt;&lt; endl;</span>
<a name="l00213"></a>00213       <span class="comment">//      feature2sample[id].push_back(n);</span>
<a name="l00214"></a>00214     }
<a name="l00215"></a>00215   }
<a name="l00216"></a>00216   count.clear();
<a name="l00217"></a>00217 
<a name="l00218"></a>00218   <span class="comment">//  cerr &lt;&lt; "num_classes = " &lt;&lt; _num_classes &lt;&lt; endl;</span>
<a name="l00219"></a>00219   <span class="comment">//  cerr &lt;&lt; "max_num_features = " &lt;&lt; max_num_features &lt;&lt; endl;</span>
<a name="l00220"></a>00220 
<a name="l00221"></a>00221   <span class="keywordtype">int</span> c = 0;
<a name="l00222"></a>00222 
<a name="l00223"></a>00223   <a class="code" href="classME__Model.html#5d08a0ae3292a2fecf9473aee17660a8">_sample2feature</a>.clear();
<a name="l00224"></a>00224   <a class="code" href="classME__Model.html#5d08a0ae3292a2fecf9473aee17660a8">_sample2feature</a>.resize(<a class="code" href="classME__Model.html#01bbc4b24d88cda6c77db3ef17f48f19">_train</a>.size());
<a name="l00225"></a>00225 
<a name="l00226"></a>00226   n = 0;
<a name="l00227"></a>00227   <span class="keywordflow">for</span> (std::vector&lt;Sample&gt;::const_iterator i = <a class="code" href="classME__Model.html#01bbc4b24d88cda6c77db3ef17f48f19">_train</a>.begin(); i != <a class="code" href="classME__Model.html#01bbc4b24d88cda6c77db3ef17f48f19">_train</a>.end(); i++) {
<a name="l00228"></a>00228     <span class="comment">//    _sample2feature[n].resize(_num_classes);</span>
<a name="l00229"></a>00229     <span class="keywordflow">for</span> (std::list&lt;int&gt;::const_iterator j = i-&gt;positive_features.begin(); j != i-&gt;positive_features.end(); j++){
<a name="l00230"></a>00230       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; k &lt; <a class="code" href="classME__Model.html#7a85f402ac9fea030c49f7c6216df686">_num_classes</a>; k++) {
<a name="l00231"></a>00231         <span class="keywordtype">int</span> <span class="keywordtype">id</span> = <a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#91a032b84cb004c2aa9819bd5c727e29">Id</a>(<a class="code" href="structME__Model_1_1ME__Feature.html">ME_Feature</a>(k, *j));
<a name="l00232"></a>00232         <span class="keywordflow">if</span> (<span class="keywordtype">id</span> &gt;= 0) {
<a name="l00233"></a>00233           <a class="code" href="classME__Model.html#5d08a0ae3292a2fecf9473aee17660a8">_sample2feature</a>[n].push_back(<span class="keywordtype">id</span>);
<a name="l00234"></a>00234           c++;
<a name="l00235"></a>00235         }
<a name="l00236"></a>00236       }
<a name="l00237"></a>00237     }
<a name="l00238"></a>00238     n++;
<a name="l00239"></a>00239   }
<a name="l00240"></a>00240 
<a name="l00241"></a>00241   <span class="comment">//  cerr &lt;&lt; "c = " &lt;&lt; c &lt;&lt; endl;</span>
<a name="l00242"></a>00242 
<a name="l00243"></a>00243   <span class="keywordflow">return</span> max_num_features;
<a name="l00244"></a>00244 }
<a name="l00245"></a>00245 
<a name="l00246"></a>00246 <span class="keywordtype">double</span>
<a name="l00247"></a><a class="code" href="classME__Model.html#39490060a9aa91c5bfef26db89995d81">00247</a> <a class="code" href="classME__Model.html#39490060a9aa91c5bfef26db89995d81">ME_Model::heldout_likelihood</a>()
<a name="l00248"></a>00248 {
<a name="l00249"></a>00249   <span class="keywordtype">double</span> logl = 0;
<a name="l00250"></a>00250   <span class="keywordtype">int</span> ncorrect = 0;
<a name="l00251"></a>00251   <span class="keywordflow">for</span> (std::vector&lt;Sample&gt;::const_iterator i = <a class="code" href="classME__Model.html#ee10259b3dbbc99acb9c0f0e200b598b">_heldout</a>.begin(); i != <a class="code" href="classME__Model.html#ee10259b3dbbc99acb9c0f0e200b598b">_heldout</a>.end(); i++) {
<a name="l00252"></a>00252     <a class="code" href="classstd_1_1vector.html">vector&lt;double&gt;</a> membp(<a class="code" href="classME__Model.html#7a85f402ac9fea030c49f7c6216df686">_num_classes</a>);
<a name="l00253"></a>00253     <span class="keywordtype">int</span> l = <a class="code" href="classME__Model.html#28a77dc1738038d8a5a1350e157428c4">classify</a>(*i, membp);
<a name="l00254"></a>00254     logl += log(membp[i-&gt;label]);
<a name="l00255"></a>00255     <span class="keywordflow">if</span> (l == i-&gt;label) ncorrect++;
<a name="l00256"></a>00256   }
<a name="l00257"></a>00257   <a class="code" href="classME__Model.html#daf5973e7d0bf53c3d747da90dc20036">_heldout_error</a> = 1 - (double)ncorrect / <a class="code" href="classME__Model.html#ee10259b3dbbc99acb9c0f0e200b598b">_heldout</a>.size();
<a name="l00258"></a>00258 
<a name="l00259"></a>00259   <span class="keywordflow">return</span> logl /= <a class="code" href="classME__Model.html#ee10259b3dbbc99acb9c0f0e200b598b">_heldout</a>.size();
<a name="l00260"></a>00260 }
<a name="l00261"></a>00261 
<a name="l00262"></a>00262 <span class="keywordtype">double</span>
<a name="l00263"></a><a class="code" href="classME__Model.html#d21f4e1132f6d710d41d4b3ef206d1f2">00263</a> <a class="code" href="classME__Model.html#d21f4e1132f6d710d41d4b3ef206d1f2">ME_Model::update_model_expectation</a>()
<a name="l00264"></a>00264 {
<a name="l00265"></a>00265   <span class="keywordtype">double</span> logl = 0;
<a name="l00266"></a>00266   <span class="keywordtype">int</span> ncorrect = 0;
<a name="l00267"></a>00267   <span class="keywordtype">int</span> n = 0;
<a name="l00268"></a>00268   <a class="code" href="classstd_1_1vector.html">vector&lt; vector&lt;double&gt;</a> &gt; membpv;
<a name="l00269"></a>00269   <span class="keywordflow">for</span> (std::vector&lt;Sample&gt;::const_iterator i = <a class="code" href="classME__Model.html#01bbc4b24d88cda6c77db3ef17f48f19">_train</a>.begin(); i != <a class="code" href="classME__Model.html#01bbc4b24d88cda6c77db3ef17f48f19">_train</a>.end(); i++) {
<a name="l00270"></a>00270     <a class="code" href="classstd_1_1vector.html">vector&lt;double&gt;</a> membp(<a class="code" href="classME__Model.html#7a85f402ac9fea030c49f7c6216df686">_num_classes</a>);
<a name="l00271"></a>00271     <span class="keywordtype">int</span> max_label = 0;
<a name="l00272"></a>00272 
<a name="l00273"></a>00273     <span class="keywordtype">double</span> sum = 0;
<a name="l00274"></a>00274     <a class="code" href="classstd_1_1vector.html">vector&lt;double&gt;</a> powv(<a class="code" href="classME__Model.html#7a85f402ac9fea030c49f7c6216df686">_num_classes</a>);
<a name="l00275"></a>00275     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> label = 0; label &lt; <a class="code" href="classME__Model.html#7a85f402ac9fea030c49f7c6216df686">_num_classes</a>; label++) powv[label] = 0;
<a name="l00276"></a>00276     <span class="keyword">const</span> <a class="code" href="classstd_1_1vector.html">vector&lt;int&gt;</a> &amp; fl = <a class="code" href="classME__Model.html#5d08a0ae3292a2fecf9473aee17660a8">_sample2feature</a>[n];
<a name="l00277"></a>00277     <span class="keywordflow">for</span> (std::vector&lt;int&gt;::const_iterator j = fl.begin(); j != fl.end(); j++){
<a name="l00278"></a>00278       powv[<a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#8f70045a4517cc8075832474eb4e01f1">Feature</a>(*j).<a class="code" href="structME__Model_1_1ME__Feature.html#7357fa87b4d4760b2410d68bfb7e43c5">label</a>()] += <a class="code" href="classME__Model.html#a0dc1dcca7431b816b27c1d7c9f0379a">_vl</a>[*j];
<a name="l00279"></a>00279     }
<a name="l00280"></a>00280     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> label = 0; label &lt; _num_classes; label++) {
<a name="l00281"></a>00281       <span class="keywordtype">double</span> pow = powv[label];
<a name="l00282"></a>00282       <span class="keywordtype">double</span> prod = exp(pow);
<a name="l00283"></a>00283       membp[label] = prod;
<a name="l00284"></a>00284       sum += prod;
<a name="l00285"></a>00285     }
<a name="l00286"></a>00286     <span class="comment">/*</span>
<a name="l00287"></a>00287 <span class="comment">    const vector&lt;int&gt; &amp; fl = _sample2feature[n];</span>
<a name="l00288"></a>00288 <span class="comment">    double sum = 0;</span>
<a name="l00289"></a>00289 <span class="comment">    for (int label = 0; label &lt; _num_classes; label++) {</span>
<a name="l00290"></a>00290 <span class="comment">      double pow = 0.0;</span>
<a name="l00291"></a>00291 <span class="comment">      for (std::vector&lt;int&gt;::const_iterator i = fl.begin(); i != fl.end(); i++){</span>
<a name="l00292"></a>00292 <span class="comment">        ME_Feature f = _fb.Feature(*i);</span>
<a name="l00293"></a>00293 <span class="comment">        if (f.label() != label) continue;</span>
<a name="l00294"></a>00294 <span class="comment">        pow += _vl[*i];</span>
<a name="l00295"></a>00295 <span class="comment">      }</span>
<a name="l00296"></a>00296 <span class="comment">      double prod = exp(pow);</span>
<a name="l00297"></a>00297 <span class="comment">      membp[label] = prod;</span>
<a name="l00298"></a>00298 <span class="comment">      sum += prod;</span>
<a name="l00299"></a>00299 <span class="comment">    }</span>
<a name="l00300"></a>00300 <span class="comment">    */</span>
<a name="l00301"></a>00301     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> label = 0; label &lt; _num_classes; label++) {
<a name="l00302"></a>00302       membp[label] /= sum;
<a name="l00303"></a>00303       <span class="keywordflow">if</span> (membp[label] &gt; membp[max_label]) max_label = label;
<a name="l00304"></a>00304     }
<a name="l00305"></a>00305 
<a name="l00306"></a>00306     logl += log(membp[i-&gt;label]);
<a name="l00307"></a>00307     <span class="keywordflow">if</span> (max_label == i-&gt;label) ncorrect++;
<a name="l00308"></a>00308     membpv.push_back(membp);
<a name="l00309"></a>00309     n++;
<a name="l00310"></a>00310   }
<a name="l00311"></a>00311 
<a name="l00312"></a>00312   <span class="comment">// model expectation</span>
<a name="l00313"></a>00313   <a class="code" href="classME__Model.html#f73cc90b01028ab54527df94d6c8a123">_vme</a>.resize(<a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#ef349bd03d50de36081b42ee5c717b86">Size</a>());
<a name="l00314"></a>00314   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#ef349bd03d50de36081b42ee5c717b86">Size</a>(); i++) {
<a name="l00315"></a>00315     <a class="code" href="classME__Model.html#f73cc90b01028ab54527df94d6c8a123">_vme</a>[i] = 0;
<a name="l00316"></a>00316   }
<a name="l00317"></a>00317   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> n = 0; n &lt; (int)<a class="code" href="classME__Model.html#01bbc4b24d88cda6c77db3ef17f48f19">_train</a>.size(); n++) {
<a name="l00318"></a>00318     <span class="comment">//    for (int i = 0; i &lt; _num_classes; i++) {</span>
<a name="l00319"></a>00319     <span class="comment">//      const vector&lt;int&gt; &amp; fl = _sample2feature[n][i];</span>
<a name="l00320"></a>00320     <span class="comment">//      for (vector&lt;int&gt;::const_iterator j = fl.begin(); j != fl.end(); j++) {</span>
<a name="l00321"></a>00321     <span class="comment">//        _vme[*j] += membpv[n][_fb.Feature(*j).label()];</span>
<a name="l00322"></a>00322     <span class="comment">//      }</span>
<a name="l00323"></a>00323     <span class="comment">//    }</span>
<a name="l00324"></a>00324     <span class="keyword">const</span> <a class="code" href="classstd_1_1vector.html">vector&lt;int&gt;</a> &amp; fl = <a class="code" href="classME__Model.html#5d08a0ae3292a2fecf9473aee17660a8">_sample2feature</a>[n];
<a name="l00325"></a>00325     <span class="keywordflow">for</span> (<a class="code" href="classstd_1_1vector.html">vector&lt;int&gt;::const_iterator</a> j = fl.begin(); j != fl.end(); j++) {
<a name="l00326"></a>00326       <a class="code" href="classME__Model.html#f73cc90b01028ab54527df94d6c8a123">_vme</a>[*j] += membpv[n][<a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#8f70045a4517cc8075832474eb4e01f1">Feature</a>(*j).<a class="code" href="structME__Model_1_1ME__Feature.html#7357fa87b4d4760b2410d68bfb7e43c5">label</a>()];
<a name="l00327"></a>00327     }
<a name="l00328"></a>00328   }
<a name="l00329"></a>00329   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#ef349bd03d50de36081b42ee5c717b86">Size</a>(); i++) {
<a name="l00330"></a>00330     <a class="code" href="classME__Model.html#f73cc90b01028ab54527df94d6c8a123">_vme</a>[i] /= <a class="code" href="classME__Model.html#01bbc4b24d88cda6c77db3ef17f48f19">_train</a>.size();
<a name="l00331"></a>00331   }
<a name="l00332"></a>00332 
<a name="l00333"></a>00333   <a class="code" href="classME__Model.html#aab235eaccf24824812370d60ca079e4">_train_error</a> = 1 - (double)ncorrect / <a class="code" href="classME__Model.html#01bbc4b24d88cda6c77db3ef17f48f19">_train</a>.size();
<a name="l00334"></a>00334 
<a name="l00335"></a>00335   logl /= <a class="code" href="classME__Model.html#01bbc4b24d88cda6c77db3ef17f48f19">_train</a>.size();
<a name="l00336"></a>00336 
<a name="l00337"></a>00337   <span class="keywordflow">if</span> (<a class="code" href="classME__Model.html#8fe5e308a2901c6792abe6c305491bcd">_inequality_width</a> &gt; 0) {
<a name="l00338"></a>00338     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#ef349bd03d50de36081b42ee5c717b86">Size</a>(); i++) {
<a name="l00339"></a>00339       logl -= (<a class="code" href="classME__Model.html#30e8d601c952bf0aa22da5837149e7a1">_va</a>[i] + <a class="code" href="classME__Model.html#85968df26e2c2515e94e9d7dc5904d80">_vb</a>[i]) * <a class="code" href="classME__Model.html#8fe5e308a2901c6792abe6c305491bcd">_inequality_width</a>;
<a name="l00340"></a>00340     }
<a name="l00341"></a>00341   } <span class="keywordflow">else</span> {
<a name="l00342"></a>00342     <span class="keywordflow">if</span> (<a class="code" href="classME__Model.html#da41f84f6e6c25acec3698903f3a5cb3">_sigma</a> &gt; 0) {
<a name="l00343"></a>00343       <span class="keyword">const</span> <span class="keywordtype">double</span> c = 1/(2*<a class="code" href="classME__Model.html#da41f84f6e6c25acec3698903f3a5cb3">_sigma</a>*<a class="code" href="classME__Model.html#da41f84f6e6c25acec3698903f3a5cb3">_sigma</a>);
<a name="l00344"></a>00344       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#ef349bd03d50de36081b42ee5c717b86">Size</a>(); i++) {
<a name="l00345"></a>00345         logl -= <a class="code" href="classME__Model.html#a0dc1dcca7431b816b27c1d7c9f0379a">_vl</a>[i] * <a class="code" href="classME__Model.html#a0dc1dcca7431b816b27c1d7c9f0379a">_vl</a>[i] * c;
<a name="l00346"></a>00346       }
<a name="l00347"></a>00347     }
<a name="l00348"></a>00348   }
<a name="l00349"></a>00349 
<a name="l00350"></a>00350   <span class="comment">//logl /= _train.size();</span>
<a name="l00351"></a>00351 
<a name="l00352"></a>00352   <span class="comment">//  fprintf(stderr, "iter =%3d  logl = %10.7f  train_acc = %7.5f\n", iter, logl, (double)ncorrect/train.size());</span>
<a name="l00353"></a>00353   <span class="comment">//  fprintf(stderr, "logl = %10.7f  train_acc = %7.5f\n", logl, (double)ncorrect/_train.size());</span>
<a name="l00354"></a>00354 
<a name="l00355"></a>00355   <span class="keywordflow">return</span> logl;
<a name="l00356"></a>00356 }
<a name="l00357"></a>00357 
<a name="l00358"></a>00358 <span class="keywordtype">int</span>
<a name="l00359"></a>00359 <a class="code" href="classME__Model.html#246ff3f37fbee3abf4bef0f978bd031e">ME_Model::train</a>(<span class="keyword">const</span> vector&lt;ME_Sample&gt; &amp; vms, <span class="keyword">const</span> <span class="keywordtype">int</span> cutoff,
<a name="l00360"></a>00360                 <span class="keyword">const</span> <span class="keywordtype">double</span> sigma, <span class="keyword">const</span> <span class="keywordtype">double</span> widthfactor)
<a name="l00361"></a>00361 {
<a name="l00362"></a>00362   <span class="keywordflow">if</span> (sigma &gt; 0 &amp;&amp; widthfactor &gt; 0) {
<a name="l00363"></a>00363     cerr &lt;&lt; <span class="stringliteral">"warning: Gausian prior and inequality ME cannot be used at the same time."</span> &lt;&lt; endl;
<a name="l00364"></a>00364   }
<a name="l00365"></a>00365   <span class="keywordflow">if</span> (<a class="code" href="classME__Model.html#ba7ea42febb256bf94f54245255a34a5">_nheldout</a> &gt;= vms.size()) {
<a name="l00366"></a>00366     cerr &lt;&lt; <span class="stringliteral">"error: too much heldout data. no training data is available."</span> &lt;&lt; endl;
<a name="l00367"></a>00367     <span class="keywordflow">return</span> 0;
<a name="l00368"></a>00368   }
<a name="l00369"></a>00369 
<a name="l00370"></a>00370   <span class="comment">// convert ME_Sample to Sample</span>
<a name="l00371"></a>00371   vector&lt;Sample&gt; vs;
<a name="l00372"></a>00372   <span class="keywordflow">for</span> (vector&lt;ME_Sample&gt;::const_iterator i = vms.begin(); i != vms.end(); i++) {
<a name="l00373"></a>00373     Sample s;
<a name="l00374"></a>00374     s.label = <a class="code" href="classME__Model.html#4182ebe09a43ab1e94d6b438d79c3075">_label_bag</a>.<a class="code" href="structME__Model_1_1StringBag.html#d31d8c058e0795df0d25ee806088db1a">Put</a>(i-&gt;label);
<a name="l00375"></a>00375     <span class="keywordflow">for</span> (vector&lt;string&gt;::const_iterator j = i-&gt;features.begin(); j != i-&gt;features.end(); j++) {
<a name="l00376"></a>00376       s.positive_features.push_back(<a class="code" href="classME__Model.html#97517bda659bd3137e6e94810f08897d">_featurename_bag</a>.<a class="code" href="structME__Model_1_1MiniStringBag.html#32f0102a227ee280ebda9e3555bb1fb1">Put</a>(*j));
<a name="l00377"></a>00377     }
<a name="l00378"></a>00378     vs.push_back(s);
<a name="l00379"></a>00379   }
<a name="l00380"></a>00380 
<a name="l00381"></a>00381   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; (int)vs.size() - <a class="code" href="classME__Model.html#ba7ea42febb256bf94f54245255a34a5">_nheldout</a>; i++) <a class="code" href="classME__Model.html#01bbc4b24d88cda6c77db3ef17f48f19">_train</a>.push_back(vs[i]);
<a name="l00382"></a>00382   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = vs.size() - <a class="code" href="classME__Model.html#ba7ea42febb256bf94f54245255a34a5">_nheldout</a>; i &lt; (int)vs.size(); i++) <a class="code" href="classME__Model.html#ee10259b3dbbc99acb9c0f0e200b598b">_heldout</a>.push_back(vs[i]);
<a name="l00383"></a>00383   vs.clear();
<a name="l00384"></a>00384 
<a name="l00385"></a>00385   <span class="comment">//  _sigma = sqrt(Nsigma2 / (double)_train.size());</span>
<a name="l00386"></a>00386   <a class="code" href="classME__Model.html#da41f84f6e6c25acec3698903f3a5cb3">_sigma</a> = sigma;
<a name="l00387"></a>00387   <a class="code" href="classME__Model.html#8fe5e308a2901c6792abe6c305491bcd">_inequality_width</a> = widthfactor / <a class="code" href="classME__Model.html#01bbc4b24d88cda6c77db3ef17f48f19">_train</a>.size();
<a name="l00388"></a>00388 
<a name="l00389"></a>00389   <span class="keywordflow">if</span> (cutoff &gt; 0)
<a name="l00390"></a>00390     cerr &lt;&lt; <span class="stringliteral">"cutoff threshold = "</span> &lt;&lt; cutoff &lt;&lt; endl;
<a name="l00391"></a>00391   <span class="keywordflow">if</span> (<a class="code" href="classME__Model.html#da41f84f6e6c25acec3698903f3a5cb3">_sigma</a> &gt; 0)
<a name="l00392"></a>00392     cerr &lt;&lt; <span class="stringliteral">"Gaussian prior sigma = "</span> &lt;&lt; <a class="code" href="classME__Model.html#da41f84f6e6c25acec3698903f3a5cb3">_sigma</a> &lt;&lt; endl;
<a name="l00393"></a>00393     <span class="comment">//    cerr &lt;&lt; "N*sigma^2 = " &lt;&lt; Nsigma2 &lt;&lt; " sigma = " &lt;&lt; _sigma &lt;&lt; endl;</span>
<a name="l00394"></a>00394   <span class="keywordflow">if</span> (widthfactor &gt; 0)
<a name="l00395"></a>00395     cerr &lt;&lt; <span class="stringliteral">"widthfactor = "</span> &lt;&lt; widthfactor &lt;&lt; endl;
<a name="l00396"></a>00396   cerr &lt;&lt; <span class="stringliteral">"preparing for estimation..."</span>;
<a name="l00397"></a>00397   <span class="keywordtype">int</span> C = <a class="code" href="classME__Model.html#44b71ee757d6494e852ea36bacfe6634">make_feature_bag</a>(cutoff);
<a name="l00398"></a>00398   cerr &lt;&lt; <span class="stringliteral">"done"</span> &lt;&lt; endl;
<a name="l00399"></a>00399   cerr &lt;&lt; <span class="stringliteral">"number of samples = "</span> &lt;&lt; <a class="code" href="classME__Model.html#01bbc4b24d88cda6c77db3ef17f48f19">_train</a>.size() &lt;&lt; endl;
<a name="l00400"></a>00400   cerr &lt;&lt; <span class="stringliteral">"number of features = "</span> &lt;&lt; <a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#ef349bd03d50de36081b42ee5c717b86">Size</a>() &lt;&lt; endl;
<a name="l00401"></a>00401 
<a name="l00402"></a>00402   cerr &lt;&lt; <span class="stringliteral">"calculating empirical expectation..."</span>;
<a name="l00403"></a>00403   <a class="code" href="classME__Model.html#6d1c21872d8899cd512ce560216bcfda">_vee</a>.resize(<a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#ef349bd03d50de36081b42ee5c717b86">Size</a>());
<a name="l00404"></a>00404   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#ef349bd03d50de36081b42ee5c717b86">Size</a>(); i++) {
<a name="l00405"></a>00405     <a class="code" href="classME__Model.html#6d1c21872d8899cd512ce560216bcfda">_vee</a>[i] = 0;
<a name="l00406"></a>00406   }
<a name="l00407"></a>00407   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> n = 0; n &lt; (int)<a class="code" href="classME__Model.html#01bbc4b24d88cda6c77db3ef17f48f19">_train</a>.size(); n++) {
<a name="l00408"></a>00408     <span class="keyword">const</span> vector&lt;int&gt; &amp; fl = <a class="code" href="classME__Model.html#5d08a0ae3292a2fecf9473aee17660a8">_sample2feature</a>[n];
<a name="l00409"></a>00409     <span class="keywordflow">for</span> (vector&lt;int&gt;::const_iterator j = fl.begin(); j != fl.end(); j++) {
<a name="l00410"></a>00410       <span class="keywordflow">if</span> (<a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#8f70045a4517cc8075832474eb4e01f1">Feature</a>(*j).<a class="code" href="structME__Model_1_1ME__Feature.html#7357fa87b4d4760b2410d68bfb7e43c5">label</a>() == <a class="code" href="classME__Model.html#01bbc4b24d88cda6c77db3ef17f48f19">_train</a>[n].label) {
<a name="l00411"></a>00411         <a class="code" href="classME__Model.html#6d1c21872d8899cd512ce560216bcfda">_vee</a>[*j] += 1.0;
<a name="l00412"></a>00412       }
<a name="l00413"></a>00413     }
<a name="l00414"></a>00414   }
<a name="l00415"></a>00415   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#ef349bd03d50de36081b42ee5c717b86">Size</a>(); i++) {
<a name="l00416"></a>00416     <a class="code" href="classME__Model.html#6d1c21872d8899cd512ce560216bcfda">_vee</a>[i] /= <a class="code" href="classME__Model.html#01bbc4b24d88cda6c77db3ef17f48f19">_train</a>.size();
<a name="l00417"></a>00417   }
<a name="l00418"></a>00418   cerr &lt;&lt; <span class="stringliteral">"done"</span> &lt;&lt; endl;
<a name="l00419"></a>00419 
<a name="l00420"></a>00420   <a class="code" href="classME__Model.html#a0dc1dcca7431b816b27c1d7c9f0379a">_vl</a>.resize(<a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#ef349bd03d50de36081b42ee5c717b86">Size</a>());
<a name="l00421"></a>00421   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#ef349bd03d50de36081b42ee5c717b86">Size</a>(); i++) <a class="code" href="classME__Model.html#a0dc1dcca7431b816b27c1d7c9f0379a">_vl</a>[i] = 0.0;
<a name="l00422"></a>00422   <span class="keywordflow">if</span> (<a class="code" href="classME__Model.html#8fe5e308a2901c6792abe6c305491bcd">_inequality_width</a> &gt; 0) {
<a name="l00423"></a>00423     <a class="code" href="classME__Model.html#30e8d601c952bf0aa22da5837149e7a1">_va</a>.resize(<a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#ef349bd03d50de36081b42ee5c717b86">Size</a>());
<a name="l00424"></a>00424     <a class="code" href="classME__Model.html#85968df26e2c2515e94e9d7dc5904d80">_vb</a>.resize(<a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#ef349bd03d50de36081b42ee5c717b86">Size</a>());
<a name="l00425"></a>00425     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#ef349bd03d50de36081b42ee5c717b86">Size</a>(); i++) {
<a name="l00426"></a>00426       <a class="code" href="classME__Model.html#30e8d601c952bf0aa22da5837149e7a1">_va</a>[i] = 0.0;
<a name="l00427"></a>00427       <a class="code" href="classME__Model.html#85968df26e2c2515e94e9d7dc5904d80">_vb</a>[i] = 0.0;
<a name="l00428"></a>00428     }
<a name="l00429"></a>00429   }
<a name="l00430"></a>00430 
<a name="l00431"></a>00431   <span class="comment">//perform_GIS(C);</span>
<a name="l00432"></a>00432   <a class="code" href="classME__Model.html#754103cb516b470c0d74538e3fca78b6">perform_LMVM</a>();
<a name="l00433"></a>00433 
<a name="l00434"></a>00434   <span class="keywordflow">if</span> (<a class="code" href="classME__Model.html#8fe5e308a2901c6792abe6c305491bcd">_inequality_width</a> &gt; 0) {
<a name="l00435"></a>00435     <span class="keywordtype">int</span> sum = 0;
<a name="l00436"></a>00436     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#ef349bd03d50de36081b42ee5c717b86">Size</a>(); i++) {
<a name="l00437"></a>00437       <span class="keywordflow">if</span> (<a class="code" href="classME__Model.html#a0dc1dcca7431b816b27c1d7c9f0379a">_vl</a>[i] != 0) sum++;
<a name="l00438"></a>00438     }
<a name="l00439"></a>00439     cerr &lt;&lt; <span class="stringliteral">"number of active features = "</span> &lt;&lt; sum &lt;&lt; endl;
<a name="l00440"></a>00440   }
<a name="l00441"></a>00441 
<a name="l00442"></a>00442 }
<a name="l00443"></a>00443 
<a name="l00444"></a>00444 <span class="keywordtype">void</span>
<a name="l00445"></a>00445 <a class="code" href="classME__Model.html#bd1372fb000a4fdc8ef9b560a0c8b4c3">ME_Model::get_features</a>(list&lt; pair&lt; pair&lt;string, string&gt;, <span class="keywordtype">double</span>&gt; &gt; &amp; fl)
<a name="l00446"></a>00446 {
<a name="l00447"></a>00447   fl.clear();
<a name="l00448"></a>00448   <span class="comment">//  for (int i = 0; i &lt; _fb.Size(); i++) {</span>
<a name="l00449"></a>00449   <span class="comment">//    ME_Feature f = _fb.Feature(i);</span>
<a name="l00450"></a>00450   <span class="comment">//    fl.push_back( make_pair(make_pair(_label_bag.Str(f.label()), _featurename_bag.Str(f.feature())), _vl[i]));</span>
<a name="l00451"></a>00451   <span class="comment">//  }</span>
<a name="l00452"></a>00452   <span class="keywordflow">for</span> (MiniStringBag::map_type::const_iterator i = <a class="code" href="classME__Model.html#97517bda659bd3137e6e94810f08897d">_featurename_bag</a>.<a class="code" href="structME__Model_1_1MiniStringBag.html#f5f835816a42486039673465a9673dde">begin</a>();
<a name="l00453"></a>00453        i != <a class="code" href="classME__Model.html#97517bda659bd3137e6e94810f08897d">_featurename_bag</a>.<a class="code" href="structME__Model_1_1MiniStringBag.html#e4a3cd6f62c486989707ab465ef4a6a8">end</a>(); i++) {
<a name="l00454"></a>00454     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; <a class="code" href="classME__Model.html#4182ebe09a43ab1e94d6b438d79c3075">_label_bag</a>.<a class="code" href="structME__Model_1_1StringBag.html#f1fc09c60ddd0274cc3f4b81377f626f">Size</a>(); j++) {
<a name="l00455"></a>00455       <span class="keywordtype">string</span> label = <a class="code" href="classME__Model.html#4182ebe09a43ab1e94d6b438d79c3075">_label_bag</a>.<a class="code" href="structME__Model_1_1StringBag.html#fd579fe2b81e3cdd3a30761b1486ce41">Str</a>(j);
<a name="l00456"></a>00456       <span class="keywordtype">string</span> history = i-&gt;first;
<a name="l00457"></a>00457       <span class="keywordtype">int</span> <span class="keywordtype">id</span> = <a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#91a032b84cb004c2aa9819bd5c727e29">Id</a>(ME_Feature(j, i-&gt;second));
<a name="l00458"></a>00458       <span class="keywordflow">if</span> (<span class="keywordtype">id</span> &lt; 0) <span class="keywordflow">continue</span>;
<a name="l00459"></a>00459       fl.push_back( make_pair(make_pair(label, history), <a class="code" href="classME__Model.html#a0dc1dcca7431b816b27c1d7c9f0379a">_vl</a>[<span class="keywordtype">id</span>]) );
<a name="l00460"></a>00460     }
<a name="l00461"></a>00461   }
<a name="l00462"></a>00462 }
<a name="l00463"></a>00463 
<a name="l00464"></a>00464 <span class="keywordtype">bool</span>
<a name="l00465"></a>00465 <a class="code" href="classME__Model.html#a1e19dc4d15bc1c0f4602a1bbd9174a4">ME_Model::load_from_file</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; filename)
<a name="l00466"></a>00466 {
<a name="l00467"></a>00467   FILE * fp = fopen(filename.c_str(), <span class="stringliteral">"r"</span>);
<a name="l00468"></a>00468   <span class="keywordflow">if</span> (!fp) {
<a name="l00469"></a>00469     cerr &lt;&lt; <span class="stringliteral">"error: cannot open "</span> &lt;&lt; filename &lt;&lt; <span class="stringliteral">"!"</span> &lt;&lt; endl;
<a name="l00470"></a>00470     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00471"></a>00471   }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473   <a class="code" href="classME__Model.html#a0dc1dcca7431b816b27c1d7c9f0379a">_vl</a>.clear();
<a name="l00474"></a>00474   <a class="code" href="classME__Model.html#4182ebe09a43ab1e94d6b438d79c3075">_label_bag</a>.<a class="code" href="structME__Model_1_1StringBag.html#ce3d97f271ebaa31f4f09399b2c618db">Clear</a>();
<a name="l00475"></a>00475   <a class="code" href="classME__Model.html#97517bda659bd3137e6e94810f08897d">_featurename_bag</a>.<a class="code" href="structME__Model_1_1MiniStringBag.html#8e33bf101509ddad253cd10a781474dd">Clear</a>();
<a name="l00476"></a>00476   <a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#4ec198541dd60323cc15e72a246a0705">Clear</a>();
<a name="l00477"></a>00477   <span class="keywordtype">char</span> buf[1024];
<a name="l00478"></a>00478   <span class="keywordflow">while</span>(fgets(buf, 1024, fp)) {
<a name="l00479"></a>00479     <span class="keywordtype">string</span> line(buf);
<a name="l00480"></a>00480     string::size_type t1 = line.find_first_of(<span class="charliteral">'\t'</span>);
<a name="l00481"></a>00481     string::size_type t2 = line.find_last_of(<span class="charliteral">'\t'</span>);
<a name="l00482"></a>00482     <span class="keywordtype">string</span> classname = line.substr(0, t1);
<a name="l00483"></a>00483     <span class="keywordtype">string</span> featurename = line.substr(t1 + 1, t2 - (t1 + 1) );
<a name="l00484"></a>00484     <span class="keywordtype">float</span> lambda;
<a name="l00485"></a>00485     <span class="keywordtype">string</span> w = line.substr(t2+1);
<a name="l00486"></a>00486     sscanf(w.c_str(), <span class="stringliteral">"%f"</span>, &amp;lambda);
<a name="l00487"></a>00487 
<a name="l00488"></a>00488     <span class="keywordtype">int</span> label = <a class="code" href="classME__Model.html#4182ebe09a43ab1e94d6b438d79c3075">_label_bag</a>.<a class="code" href="structME__Model_1_1StringBag.html#d31d8c058e0795df0d25ee806088db1a">Put</a>(classname);
<a name="l00489"></a>00489     <span class="keywordtype">int</span> feature = <a class="code" href="classME__Model.html#97517bda659bd3137e6e94810f08897d">_featurename_bag</a>.<a class="code" href="structME__Model_1_1MiniStringBag.html#32f0102a227ee280ebda9e3555bb1fb1">Put</a>(featurename);
<a name="l00490"></a>00490     <a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#48df0cadbce52d82f012afd809d0eed4">Put</a>(ME_Feature(label, feature));
<a name="l00491"></a>00491     <a class="code" href="classME__Model.html#a0dc1dcca7431b816b27c1d7c9f0379a">_vl</a>.push_back(lambda);
<a name="l00492"></a>00492   }
<a name="l00493"></a>00493 
<a name="l00494"></a>00494   <a class="code" href="classME__Model.html#7a85f402ac9fea030c49f7c6216df686">_num_classes</a> = <a class="code" href="classME__Model.html#4182ebe09a43ab1e94d6b438d79c3075">_label_bag</a>.<a class="code" href="structME__Model_1_1StringBag.html#f1fc09c60ddd0274cc3f4b81377f626f">Size</a>();
<a name="l00495"></a>00495 
<a name="l00496"></a>00496   fclose(fp);
<a name="l00497"></a>00497 
<a name="l00498"></a>00498   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00499"></a>00499 }
<a name="l00500"></a>00500 
<a name="l00501"></a>00501 <span class="keywordtype">bool</span>
<a name="l00502"></a><a class="code" href="classME__Model.html#9c920643190ccbec467e4e9cf916c4b8">00502</a> <a class="code" href="classME__Model.html#9c920643190ccbec467e4e9cf916c4b8">ME_Model::load_from_array</a>(<span class="keyword">const</span> <a class="code" href="structME__Model__Data.html">ME_Model_Data</a> data[])
<a name="l00503"></a>00503 {
<a name="l00504"></a>00504   <a class="code" href="classME__Model.html#a0dc1dcca7431b816b27c1d7c9f0379a">_vl</a>.clear();
<a name="l00505"></a>00505   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0;; i++) {
<a name="l00506"></a>00506     <span class="keywordflow">if</span> (<span class="keywordtype">string</span>(data[i].label) == <span class="stringliteral">"///"</span>) <span class="keywordflow">break</span>;
<a name="l00507"></a>00507     <span class="keywordtype">int</span> label = <a class="code" href="classME__Model.html#4182ebe09a43ab1e94d6b438d79c3075">_label_bag</a>.<a class="code" href="structME__Model_1_1StringBag.html#d31d8c058e0795df0d25ee806088db1a">Put</a>(data[i].label);
<a name="l00508"></a>00508     <span class="keywordtype">int</span> feature = <a class="code" href="classME__Model.html#97517bda659bd3137e6e94810f08897d">_featurename_bag</a>.<a class="code" href="structME__Model_1_1MiniStringBag.html#32f0102a227ee280ebda9e3555bb1fb1">Put</a>(data[i].feature);
<a name="l00509"></a>00509     <a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#48df0cadbce52d82f012afd809d0eed4">Put</a>(<a class="code" href="structME__Model_1_1ME__Feature.html">ME_Feature</a>(label, feature));
<a name="l00510"></a>00510     <a class="code" href="classME__Model.html#a0dc1dcca7431b816b27c1d7c9f0379a">_vl</a>.push_back(data[i].weight);
<a name="l00511"></a>00511   }
<a name="l00512"></a>00512   <a class="code" href="classME__Model.html#7a85f402ac9fea030c49f7c6216df686">_num_classes</a> = <a class="code" href="classME__Model.html#4182ebe09a43ab1e94d6b438d79c3075">_label_bag</a>.<a class="code" href="structME__Model_1_1StringBag.html#f1fc09c60ddd0274cc3f4b81377f626f">Size</a>();
<a name="l00513"></a>00513   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00514"></a>00514 }
<a name="l00515"></a>00515 
<a name="l00516"></a>00516 <span class="keywordtype">bool</span>
<a name="l00517"></a>00517 <a class="code" href="classME__Model.html#f87748d7eecfe434b3d8091e0bae51b5">ME_Model::save_to_file</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; filename)<span class="keyword"> const</span>
<a name="l00518"></a>00518 <span class="keyword"></span>{
<a name="l00519"></a>00519   FILE * fp = fopen(filename.c_str(), <span class="stringliteral">"w"</span>);
<a name="l00520"></a>00520   <span class="keywordflow">if</span> (!fp) {
<a name="l00521"></a>00521     cerr &lt;&lt; <span class="stringliteral">"error: cannot open "</span> &lt;&lt; filename &lt;&lt; <span class="stringliteral">"!"</span> &lt;&lt; endl;
<a name="l00522"></a>00522     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00523"></a>00523   }
<a name="l00524"></a>00524 
<a name="l00525"></a>00525   <span class="comment">//  for (int i = 0; i &lt; _fb.Size(); i++) {</span>
<a name="l00526"></a>00526   <span class="comment">//    if (_vl[i] == 0) continue; // ignore zero-weight features</span>
<a name="l00527"></a>00527   <span class="comment">//    ME_Feature f = _fb.Feature(i);</span>
<a name="l00528"></a>00528   <span class="comment">//    fprintf(fp, "%s\t%s\t%f\n", _label_bag.Str(f.label()).c_str(), _featurename_bag.Str(f.feature()).c_str(), _vl[i]);</span>
<a name="l00529"></a>00529   <span class="comment">//  }</span>
<a name="l00530"></a>00530   <span class="keywordflow">for</span> (MiniStringBag::map_type::const_iterator i = <a class="code" href="classME__Model.html#97517bda659bd3137e6e94810f08897d">_featurename_bag</a>.<a class="code" href="structME__Model_1_1MiniStringBag.html#f5f835816a42486039673465a9673dde">begin</a>();
<a name="l00531"></a>00531        i != <a class="code" href="classME__Model.html#97517bda659bd3137e6e94810f08897d">_featurename_bag</a>.<a class="code" href="structME__Model_1_1MiniStringBag.html#e4a3cd6f62c486989707ab465ef4a6a8">end</a>(); i++) {
<a name="l00532"></a>00532     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; <a class="code" href="classME__Model.html#4182ebe09a43ab1e94d6b438d79c3075">_label_bag</a>.<a class="code" href="structME__Model_1_1StringBag.html#f1fc09c60ddd0274cc3f4b81377f626f">Size</a>(); j++) {
<a name="l00533"></a>00533       <span class="keywordtype">string</span> label = <a class="code" href="classME__Model.html#4182ebe09a43ab1e94d6b438d79c3075">_label_bag</a>.<a class="code" href="structME__Model_1_1StringBag.html#fd579fe2b81e3cdd3a30761b1486ce41">Str</a>(j);
<a name="l00534"></a>00534       <span class="keywordtype">string</span> history = i-&gt;first;
<a name="l00535"></a>00535       <span class="keywordtype">int</span> <span class="keywordtype">id</span> = <a class="code" href="classME__Model.html#b52455eefd6359c8d38631f712a07c5c">_fb</a>.<a class="code" href="structME__Model_1_1ME__FeatureBag.html#91a032b84cb004c2aa9819bd5c727e29">Id</a>(ME_Feature(j, i-&gt;second));
<a name="l00536"></a>00536       <span class="keywordflow">if</span> (<span class="keywordtype">id</span> &lt; 0) <span class="keywordflow">continue</span>;
<a name="l00537"></a>00537       <span class="keywordflow">if</span> (<a class="code" href="classME__Model.html#a0dc1dcca7431b816b27c1d7c9f0379a">_vl</a>[<span class="keywordtype">id</span>] == 0) <span class="keywordflow">continue</span>; <span class="comment">// ignore zero-weight features</span>
<a name="l00538"></a>00538       fprintf(fp, <span class="stringliteral">"%s\t%s\t%f\n"</span>, label.c_str(), history.c_str(), <a class="code" href="classME__Model.html#a0dc1dcca7431b816b27c1d7c9f0379a">_vl</a>[id]);
<a name="l00539"></a>00539     }
<a name="l00540"></a>00540   }
<a name="l00541"></a>00541 
<a name="l00542"></a>00542   fclose(fp);
<a name="l00543"></a>00543 
<a name="l00544"></a>00544   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00545"></a>00545 }
<a name="l00546"></a>00546 
<a name="l00547"></a>00547 <span class="keywordtype">int</span>
<a name="l00548"></a>00548 <a class="code" href="classME__Model.html#28a77dc1738038d8a5a1350e157428c4">ME_Model::classify</a>(<span class="keyword">const</span> Sample &amp; nbs, vector&lt;double&gt; &amp; membp)<span class="keyword"> const</span>
<a name="l00549"></a>00549 <span class="keyword"></span>{
<a name="l00550"></a>00550   <span class="comment">//  vector&lt;double&gt; membp(_num_classes);</span>
<a name="l00551"></a>00551   assert(<a class="code" href="classME__Model.html#7a85f402ac9fea030c49f7c6216df686">_num_classes</a> == (<span class="keywordtype">int</span>)membp.size());
<a name="l00552"></a>00552   <a class="code" href="classME__Model.html#8210bdb521edd5c9293b3ebba75d7c06">conditional_probability</a>(nbs, membp);
<a name="l00553"></a>00553   <span class="keywordtype">int</span> max_label = 0;
<a name="l00554"></a>00554   <span class="keywordtype">double</span> max = 0.0;
<a name="l00555"></a>00555   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; (int)membp.size(); i++) {
<a name="l00556"></a>00556     <span class="comment">//    cout &lt;&lt; membp[i] &lt;&lt; " ";</span>
<a name="l00557"></a>00557     <span class="keywordflow">if</span> (membp[i] &gt; max) { max_label = i; max = membp[i]; }
<a name="l00558"></a>00558   }
<a name="l00559"></a>00559   <span class="comment">//  cout &lt;&lt; endl;</span>
<a name="l00560"></a>00560   <span class="keywordflow">return</span> max_label;
<a name="l00561"></a>00561 }
<a name="l00562"></a>00562 
<a name="l00563"></a>00563 vector&lt;double&gt;
<a name="l00564"></a><a class="code" href="classME__Model.html#28a77dc1738038d8a5a1350e157428c4">00564</a> <a class="code" href="classME__Model.html#28a77dc1738038d8a5a1350e157428c4">ME_Model::classify</a>(<a class="code" href="structME__Sample.html">ME_Sample</a> &amp; mes)<span class="keyword"> const</span>
<a name="l00565"></a>00565 <span class="keyword"></span>{
<a name="l00566"></a>00566   <a class="code" href="structME__Model_1_1Sample.html">Sample</a> s;
<a name="l00567"></a>00567   <span class="keywordflow">for</span> (<a class="code" href="classstd_1_1vector.html">vector&lt;string&gt;::const_iterator</a> j = mes.<a class="code" href="structME__Sample.html#255f0355bcc704e37b36ad9ad31b378a">features</a>.begin(); j != mes.<a class="code" href="structME__Sample.html#255f0355bcc704e37b36ad9ad31b378a">features</a>.end(); j++) {
<a name="l00568"></a>00568     <span class="keywordtype">int</span> <span class="keywordtype">id</span> = <a class="code" href="classME__Model.html#97517bda659bd3137e6e94810f08897d">_featurename_bag</a>.<a class="code" href="structME__Model_1_1MiniStringBag.html#65ba142e048cf3786852bd42d7171fc1">Id</a>(*j);
<a name="l00569"></a>00569     <span class="keywordflow">if</span> (<span class="keywordtype">id</span> &gt;= 0)
<a name="l00570"></a>00570       s.<a class="code" href="structME__Model_1_1Sample.html#5928a57beaa5ec61aa4bccb839e35773">positive_features</a>.push_back(<span class="keywordtype">id</span>);
<a name="l00571"></a>00571   }
<a name="l00572"></a>00572 
<a name="l00573"></a>00573   <a class="code" href="classstd_1_1vector.html">vector&lt;double&gt;</a> vp(<a class="code" href="classME__Model.html#7a85f402ac9fea030c49f7c6216df686">_num_classes</a>);
<a name="l00574"></a>00574   <span class="keywordtype">int</span> label = <a class="code" href="classME__Model.html#28a77dc1738038d8a5a1350e157428c4">classify</a>(s, vp);
<a name="l00575"></a>00575   mes.<a class="code" href="structME__Sample.html#65dd665de645a8a4ba7847b0ac42290d">label</a> = <a class="code" href="classME__Model.html#ab8a707a23f53cb60a0bb6eff0a602bd">get_class_label</a>(label);
<a name="l00576"></a>00576   <span class="keywordflow">return</span> vp;
<a name="l00577"></a>00577 }
<a name="l00578"></a>00578 
<a name="l00579"></a>00579 <span class="comment">/*</span>
<a name="l00580"></a>00580 <span class="comment"> * $Log: maxent.cpp,v $</span>
<a name="l00581"></a>00581 <span class="comment"> * Revision 1.15  2005/04/27 11:22:27  tsuruoka</span>
<a name="l00582"></a>00582 <span class="comment"> * bugfix</span>
<a name="l00583"></a>00583 <span class="comment"> * ME_Sample: list -&gt; vector</span>
<a name="l00584"></a>00584 <span class="comment"> *</span>
<a name="l00585"></a>00585 <span class="comment"> * Revision 1.14  2005/04/27 10:00:42  tsuruoka</span>
<a name="l00586"></a>00586 <span class="comment"> * remove tmpfb</span>
<a name="l00587"></a>00587 <span class="comment"> *</span>
<a name="l00588"></a>00588 <span class="comment"> * Revision 1.13  2005/04/26 14:25:53  tsuruoka</span>
<a name="l00589"></a>00589 <span class="comment"> * add MiniStringBag, USE_HASH_MAP</span>
<a name="l00590"></a>00590 <span class="comment"> *</span>
<a name="l00591"></a>00591 <span class="comment"> * Revision 1.12  2005/02/11 10:20:08  tsuruoka</span>
<a name="l00592"></a>00592 <span class="comment"> * modify cutoff</span>
<a name="l00593"></a>00593 <span class="comment"> *</span>
<a name="l00594"></a>00594 <span class="comment"> * Revision 1.11  2004/10/04 05:50:25  tsuruoka</span>
<a name="l00595"></a>00595 <span class="comment"> * add Clear()</span>
<a name="l00596"></a>00596 <span class="comment"> *</span>
<a name="l00597"></a>00597 <span class="comment"> * Revision 1.10  2004/08/26 16:52:26  tsuruoka</span>
<a name="l00598"></a>00598 <span class="comment"> * fix load_from_file()</span>
<a name="l00599"></a>00599 <span class="comment"> *</span>
<a name="l00600"></a>00600 <span class="comment"> * Revision 1.9  2004/08/09 12:27:21  tsuruoka</span>
<a name="l00601"></a>00601 <span class="comment"> * change messages</span>
<a name="l00602"></a>00602 <span class="comment"> *</span>
<a name="l00603"></a>00603 <span class="comment"> * Revision 1.8  2004/08/04 13:55:18  tsuruoka</span>
<a name="l00604"></a>00604 <span class="comment"> * modify _sample2feature</span>
<a name="l00605"></a>00605 <span class="comment"> *</span>
<a name="l00606"></a>00606 <span class="comment"> * Revision 1.7  2004/07/28 13:42:58  tsuruoka</span>
<a name="l00607"></a>00607 <span class="comment"> * add AGIS</span>
<a name="l00608"></a>00608 <span class="comment"> *</span>
<a name="l00609"></a>00609 <span class="comment"> * Revision 1.6  2004/07/28 05:54:13  tsuruoka</span>
<a name="l00610"></a>00610 <span class="comment"> * get_class_name() -&gt; get_class_label()</span>
<a name="l00611"></a>00611 <span class="comment"> * ME_Feature: bugfix</span>
<a name="l00612"></a>00612 <span class="comment"> *</span>
<a name="l00613"></a>00613 <span class="comment"> * Revision 1.5  2004/07/27 16:58:47  tsuruoka</span>
<a name="l00614"></a>00614 <span class="comment"> * modify the interface of classify()</span>
<a name="l00615"></a>00615 <span class="comment"> *</span>
<a name="l00616"></a>00616 <span class="comment"> * Revision 1.4  2004/07/26 17:23:46  tsuruoka</span>
<a name="l00617"></a>00617 <span class="comment"> * _sample2feature: list -&gt; vector</span>
<a name="l00618"></a>00618 <span class="comment"> *</span>
<a name="l00619"></a>00619 <span class="comment"> * Revision 1.3  2004/07/26 15:49:23  tsuruoka</span>
<a name="l00620"></a>00620 <span class="comment"> * modify ME_Feature</span>
<a name="l00621"></a>00621 <span class="comment"> *</span>
<a name="l00622"></a>00622 <span class="comment"> * Revision 1.2  2004/07/26 13:52:18  tsuruoka</span>
<a name="l00623"></a>00623 <span class="comment"> * modify cutoff</span>
<a name="l00624"></a>00624 <span class="comment"> *</span>
<a name="l00625"></a>00625 <span class="comment"> * Revision 1.1  2004/07/26 13:10:55  tsuruoka</span>
<a name="l00626"></a>00626 <span class="comment"> * add files</span>
<a name="l00627"></a>00627 <span class="comment"> *</span>
<a name="l00628"></a>00628 <span class="comment"> * Revision 1.20  2004/07/22 08:34:45  tsuruoka</span>
<a name="l00629"></a>00629 <span class="comment"> * modify _sample2feature[]</span>
<a name="l00630"></a>00630 <span class="comment"> *</span>
<a name="l00631"></a>00631 <span class="comment"> * Revision 1.19  2004/07/21 16:33:01  tsuruoka</span>
<a name="l00632"></a>00632 <span class="comment"> * remove some comments</span>
<a name="l00633"></a>00633 <span class="comment"> *</span>
<a name="l00634"></a>00634 <span class="comment"> */</span>
<a name="l00635"></a>00635 
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Wed Jul 1 18:14:42 2009 for la-manager by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
